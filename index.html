<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üí¨ ChatMasala v7</title>
<style>
  :root {
    --bg: #f9fafb;
    --panel: #ffffff;
    --accent: #ff7043;
    --muted: #64748b;
    --incoming: #fff7ed;
    --outgoing: #e0f7fa;
  }

  [data-theme="dark"] {
    --bg: #0f172a;
    --panel: #1e293b;
    --accent: #ff8a65;
    --muted: #94a3b8;
    --incoming: #2d3748;
    --outgoing: #334155;
  }

  body {
    margin: 0;
    font-family: "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--muted);
    height: 100vh;
    display: flex;
    flex-direction: column;
  }

  header {
    background: var(--accent);
    color: white;
    padding: 12px;
    font-size: 18px;
    font-weight: 600;
    text-align: center;
    position: relative;
  }

  #themeToggle {
    position: absolute;
    top: 8px;
    right: 12px;
    background: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    padding: 4px 8px;
  }

  .room-bar {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px;
    background: var(--panel);
  }

  #roomSelect {
    flex: 1;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #ccc;
    background: var(--panel);
    color: var(--muted);
  }

  #newRoomBtn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 8px 10px;
    border-radius: 8px;
    cursor: pointer;
  }

  #deleteRoomBtn {
    background: #ef4444;
    color: white;
    border: none;
    padding: 8px 10px;
    border-radius: 8px;
    cursor: pointer;
  }

  .messages {
    flex: 1;
    padding: 12px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
    background: var(--panel);
  }

  .msg {
    display: flex;
    flex-direction: column;
    max-width: 80%;
  }

  .msg.out {
    align-self: flex-end;
    background: var(--outgoing);
    border-radius: 12px;
    padding: 8px 10px;
  }

  .msg.in {
    align-self: flex-start;
    background: var(--incoming);
    border-radius: 12px;
    padding: 8px 10px;
  }

  .msg strong {
    color: var(--accent);
    font-size: 13px;
  }

  .msg p {
    margin: 4px 0 0;
    word-wrap: break-word;
  }

  .msg img.preview {
    max-width: 200px;
    border-radius: 8px;
    margin-top: 6px;
  }

  .meta {
    font-size: 10px;
    color: var(--muted);
    margin-top: 4px;
    text-align: right;
  }

  .deleteBtn {
    background: none;
    border: none;
    color: #e11d48;
    font-size: 12px;
    cursor: pointer;
    margin-top: 4px;
    align-self: flex-end;
  }

  .composer {
    display: flex;
    align-items: center;
    padding: 8px;
    gap: 6px;
    border-top: 1px solid #ddd;
    background: var(--panel);
  }

  input[type="text"] {
    flex: 1;
    padding: 10px;
    border-radius: 18px;
    border: 1px solid #ccc;
    background: var(--bg);
  }

  .btn {
    background: var(--accent);
    color: white;
    border: none;
    border-radius: 50%;
    width: 42px;
    height: 42px;
    font-size: 18px;
    cursor: pointer;
  }

  .attach {
    background: transparent;
    border: 1px dashed #ccc;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
  }

  .typing {
    font-style: italic;
    color: var(--muted);
    font-size: 13px;
    margin: 4px 12px;
  }

  .room-meta {
    text-align: center;
    font-size: 12px;
    color: var(--muted);
    margin-bottom: 6px;
  }

  @media (max-width: 700px) {
    .msg {
      max-width: 90%;
    }
  }
</style>
</head>
<body>
  <header>
    üí¨ ChatMasala v7
    <button id="themeToggle">üåô</button>
  </header>

  <div class="room-bar">
    <select id="roomSelect"></select>
    <button id="newRoomBtn">Ôºã</button>
    <button id="deleteRoomBtn">üóëÔ∏è</button>
  </div>

  <div id="roomMeta" class="room-meta"></div>
  <div id="typingIndicator" class="typing" style="display:none;"></div>
  <div class="messages" id="messages"></div>

  <div class="composer">
    <button id="attachBtn" class="attach">üìé</button>
    <input type="file" id="fileInput" style="display:none" />
    <input type="text" id="messageInput" placeholder="Type your message..." />
    <button id="sendBtn" class="btn">‚û°Ô∏è</button>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBg_DmvYAdZe5CmyonHuOn-p12yKrwDN_E",
      authDomain: "chatmasala-e8c77.firebaseapp.com",
      databaseURL: "https://chatmasala-e8c77-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chatmasala-e8c77",
      storageBucket: "chatmasala-e8c77.firebasestorage.app",
      messagingSenderId: "106320406325",
      appId: "1:106320406325:web:686307a37df2f01ce48e7c",
      measurementId: "G-EPZN4PS4RH"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const MAX_FILE_BYTES = 2000 * 1024; // 2 MB
    const roomsRef = db.ref("rooms");

    let user = localStorage.getItem("chatUser");
    if (!user) {
      user = prompt("Enter your ChatMasala name:") || "Guest";
      localStorage.setItem("chatUser", user);
    }

    const roomSelect = document.getElementById("roomSelect");
    const newRoomBtn = document.getElementById("newRoomBtn");
    const deleteRoomBtn = document.getElementById("deleteRoomBtn");
    const roomMeta = document.getElementById("roomMeta");
    const messagesEl = document.getElementById("messages");
    const typingIndicator = document.getElementById("typingIndicator");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const attachBtn = document.getElementById("attachBtn");
    const fileInput = document.getElementById("fileInput");
    const themeToggle = document.getElementById("themeToggle");

    let currentRoom = null;
    let pendingFile = null;
    let typingTimeout = null;

    // üåô Theme toggle
    themeToggle.addEventListener("click", () => {
      const dark = document.body.dataset.theme === "dark";
      document.body.dataset.theme = dark ? "" : "dark";
      themeToggle.textContent = dark ? "üåô" : "‚òÄÔ∏è";
    });

    // Load rooms
    roomsRef.on("value", (snap) => {
      roomSelect.innerHTML = "";
      const rooms = snap.val() || {};
      Object.entries(rooms).forEach(([id, room]) => {
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = `${room.name}`;
        roomSelect.appendChild(opt);
      });
      if (!currentRoom && roomSelect.options.length > 0) {
        currentRoom = roomSelect.value;
        loadMessages(currentRoom);
      }
      updateRoomMeta();
    });

    // Create room
    newRoomBtn.addEventListener("click", () => {
      const roomName = prompt("Enter new room name:");
      if (roomName) {
        const ref = roomsRef.push({
          name: roomName,
          creator: user,
          createdAt: Date.now()
        });
        roomSelect.value = ref.key;
        currentRoom = ref.key;
        loadMessages(currentRoom);
      }
    });

    // Delete room (any user can delete)
    deleteRoomBtn.addEventListener("click", () => {
      if (!currentRoom) return alert("No room selected.");
      if (confirm("Are you sure you want to delete this room for everyone?")) {
        db.ref("messages/" + currentRoom).remove();
        db.ref("typing/" + currentRoom).remove();
        roomsRef.child(currentRoom).remove();
        currentRoom = null;
        messagesEl.innerHTML = "";
        roomSelect.innerHTML = "";
        roomMeta.textContent = "";
      }
    });

    // Select room
    roomSelect.addEventListener("change", () => {
      currentRoom = roomSelect.value;
      loadMessages(currentRoom);
    });

    function updateRoomMeta() {
      if (!currentRoom) return;
      roomsRef.child(currentRoom).once("value", (snap) => {
        const room = snap.val();
        if (room)
          roomMeta.textContent = `Created by ${room.creator} ‚Ä¢ ${new Date(room.createdAt).toLocaleString()}`;
        else roomMeta.textContent = "";
      });
    }

    function loadMessages(room) {
      messagesEl.innerHTML = "";
      db.ref("messages/" + room).off();
      db.ref("messages/" + room).on("child_added", (snap) => appendMessage(snap.val()));
      db.ref("messages/" + room).on("child_removed", (snap) => {
        const msgEl = document.getElementById("msg-" + snap.key);
        if (msgEl) msgEl.remove();
      });
      attachTypingListener(room);
      updateRoomMeta();
    }

    // Typing
    messageInput.addEventListener("input", () => sendTyping());
    function sendTyping() {
      if (!currentRoom) return;
      const ref = db.ref("typing/" + currentRoom + "/" + user);
      ref.set(Date.now());
      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => ref.remove(), 2000);
    }

    function attachTypingListener(room) {
      db.ref("typing/" + room).on("value", (snap) => {
        const val = snap.val();
        if (!val) {
          typingIndicator.style.display = "none";
          return;
        }
        const names = Object.keys(val).filter((n) => n !== user);
        if (names.length) {
          typingIndicator.textContent = `${names.join(", ")} ${
            names.length > 1 ? "are typing..." : "is typing..."
          }`;
          typingIndicator.style.display = "block";
        } else typingIndicator.style.display = "none";
      });
    }

    // File Upload
    attachBtn.onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file && file.size <= MAX_FILE_BYTES) {
        const reader = new FileReader();
        reader.onload = () => (pendingFile = { name: file.name, data: reader.result });
        reader.readAsDataURL(file);
        alert("File attached: " + file.name);
      } else alert("File too large (max 2 MB).");
    };

    // Send message
    sendBtn.onclick = sendMessage;
    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    function sendMessage() {
      if (!currentRoom) return alert("Select a room first!");
      const text = messageInput.value.trim();
      if (!text && !pendingFile) return;
      const id = db.ref("messages/" + currentRoom).push().key;
      const msg = {
        id,
        user,
        text: text || null,
        time: Date.now(),
        file: pendingFile,
      };
      db.ref("messages/" + currentRoom + "/" + id).set(msg);
      messageInput.value = "";
      pendingFile = null;
    }

    // Append messages
    function appendMessage(data) {
      const div = document.createElement("div");
      div.className = "msg " + (data.user === user ? "out" : "in");
      div.id = "msg-" + data.id;

      let html = `<strong>${data.user}</strong>`;
      if (data.text) html += `<p>${data.text}</p>`;
      if (data.file) {
        const isImg = /\.(png|jpg|jpeg|gif|webp)$/i.test(data.file.name);
        html += isImg
          ? `<a href="${data.file.data}" target="_blank"><img src="${data.file.data}" class="preview"></a>`
          : `<a href="${data.file.data}" target="_blank">üìé ${data.file.name}</a>`;
      }
      html += `<div class="meta">${new Date(data.time).toLocaleTimeString()}</div>`;
      if (data.user === user)
        html += `<button class="deleteBtn" onclick="deleteMessage('${data.id}')">üóë Delete</button>`;

      div.innerHTML = html;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function deleteMessage(id) {
      if (confirm("Delete this message?")) {
        db.ref("messages/" + currentRoom + "/" + id).remove();
      }
    }

    window.deleteMessage = deleteMessage;
  </script>
</body>
</html>
